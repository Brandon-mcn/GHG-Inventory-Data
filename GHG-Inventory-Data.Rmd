---
title: "GHG Inventory Data"
author: "Brandon-mcn"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, echo=FALSE}
if (!require("pacman")) install.packages("pacman")
library(pacman)
pacman::p_load(readxl, magrittr, tidyverse, lubridate, devtools)
install_github("Brandon-mcn/ghgtools")
library(ghgtools)
```

Welcome to the ghgtools inventory data module!

Add your activity data template to the GHG Inventory Report project folder. You can either drag and drop activity data into the provided template 'ghgtools_ActivityData' or overwrite this file with your own activity data file. Please ensure the data is formatted correctly and saved as 'ghgtools_ActivityData.xlsx'

Add your asset portfolio data template to the GHG Inventory Report project folder. You can either drag and drop activity data into the provided template 'ghgtools_AssetPortfolio_V1' or overwrite this file with your own activity data file. Please ensure the data is formatted correctly and saved as 'ghgtools_AssetPortfolio_V1.xlsx'

Enter your desired GWP here. GWP choices are "SAR", "TAR", "AR4", and "AR5"

```{r, include=FALSE}
GWP <- "AR5"
```

Now hit Ctrl+Alt+R to run all code and generate your GHG inventory data

```{r, include=FALSE, echo=FALSE}
#load in Asset Portfolio
  
  AssetPortfolio <- read_excel("ghgtools_AssetPortfolio.xlsx", sheet = "AssetPortfolio")
  
  #load in emission factor library and filter out extra columns
  
  EFL <-  read_excel("OpenEFL.xlsx", sheet = "EFL")
  
  #load in scope type mapping
  
  ScopeType <-  read_excel("OpenEFL.xlsx", sheet = "ScopeType")
  
  #load in eGRID lookup table for electricity subregions
  
  eGRIDlookup <- read_excel("OpenEFL.xlsx", sheet = "eGRIDlookup") 
  
  #load in GWPs and filter to selected assessment report
  
  x <- if(GWP == "SAR"){
    2
  } else if (GWP == "TAR"){
    3
  } else if (GWP == "AR4"){
    4
  } else if (GWP == "AR5"){
    5
  } else {
    NA
  }
  GWPs <- read_excel("OpenEFL.xlsx", sheet = "GWPs")
  GWPs <- GWPs[c(1,x)]
  
  #load Activity Data and join to Asset Portfolio
  
  GHGrawdata <- read_excel("ghgtools_ActivityData.xlsx", sheet = "ActivityData") %>%
    mutate(Year = year(Date)) %>%
    relocate(Year, .after = Date) %>%
    left_join(AssetPortfolio, by = "AssetID") %>%
    
    #join egrid_subregions for electricity to Activity Data
    
    left_join(eGRIDlookup, by = c("ZIP", "ServiceType")) %>%
    
    #map scope type and emissions category Activity Data
    
    left_join(ScopeType, by = c("AssetType", "ServiceType")) %>% 
    
    #Map emission factors to Activity Data
    
    left_join(EFL, by = c("Year", "ServiceType", "EmissionCategory", "Country", "Subregion", "UOM")) %>% 
    
    #Load GWPs
    
    add_column(GWP = colnames(GWPs[,2])) %>% 
    add_column(CO2GWP = GWPs[[1,2]]) %>%
    add_column(CH4GWP = GWPs[[2,2]]) %>%
    add_column(N2OGWP = GWPs[[3,2]]) %>%
    add_column(NF3GWP = GWPs[[4,2]]) %>%
    add_column(SF6GWP = GWPs[[5,2]]) %>% 
    
    #Calculate GHG emissions for each activity data record
    
    mutate(kgCO2e.per.UOM = (CO2_kg.per.UOM*CO2GWP) + (CH4_kg.per.UOM*CH4GWP) + (N2O_kg.per.UOM*N2OGWP) + (NF3_kg.per.UOM*NF3GWP) + (SF6_kg.per.UOM*SF6GWP) +(AUXCO2e_kg.per.UOM)) %>% 
    mutate(kgCO2e = Usage*kgCO2e.per.UOM) %>% 
    mutate(MetricTonsCO2e = kgCO2e/1000)
  
  #Generate error report
  
  GHG_ErrorReport <- GHGrawdata %>% 
    filter(is.na(MetricTonsCO2e)) %>% 
    mutate(across(everything(), as.character)) %>% 
    replace(is.na(.), "") %>% 
    write_excel_csv("GHG_ErrorReport.csv")
  
  #Generate GHG Raw Data
  
  GHG_FullRawData <- GHGrawdata %>% 
    filter(!is.na(MetricTonsCO2e)) %>% 
    mutate(across(everything(), as.character)) %>% 
    replace(is.na(.), "") %>% 
    write_excel_csv("GHG_RawData.csv")
```

